<!doctype html><html lang=en><head><title>Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar ::
Sysarmy — El blog de quienes dan soporte</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Hoy en día, es cada vez más común que los Penetration Testers, los investigadores de seguridad, Red Teams y casi cualquier persona que trabaje en sistemas requieran algún tipo de tunneling dentro y fuera de la infraestructura de una organización. Los red teams internos, especialmente, que pueden necesitar delimitar su infraestructura de comando y control, probablemente emplearán túneles SSH (o VPN, pero esa será en otra publicación) de su infraestructura externa (como callback servers, alojamiento web, correo, etc. ) hacia los activos Internos.
La configuración de estos túneles puede volverse bastante compleja y difícil de administrar, especialmente una vez que aumenta el número de saltos entre servidores.
"><meta name=keywords content="sysadmin,ssh,proxy,jumphost,bastion"><meta name=robots content="noodp"><link rel=canonical href=https://sysarmy.com/blog/posts/proxyjump-tuneles-ssh/><link rel=stylesheet href=https://sysarmy.com/blog/assets/style.css><link rel=stylesheet href=https://sysarmy.com/blog/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://sysarmy.com/blog/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://sysarmy.com/blog/img/favicon.png><link href=https://sysarmy.com/blog/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sysarmy.com/blog/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sysarmy.com/blog/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sysarmy.com/blog/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sysarmy.com/blog/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sysarmy.com/blog/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar"><meta name=twitter:description content="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-MW9RRK2")</script><script>function loadScript(e){var n=document.getElementsByTagName("head")[0],t=document.createElement("script");t.type="text/javascript",t.src="https://tracker.metricool.com/resources/be.js",t.onreadystatechange=e,t.onload=e,n.appendChild(t)}loadScript(function(){beTracker.t({hash:"b5c0b4816e829c93645aa7ad738aa3c0"})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-K4QJX7Y34Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K4QJX7Y34Y")</script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/blog class=logo style=text-decoration:none><span class=logo__mark><svg class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>sysarmy:~ blog$</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://tienda.sysarmy.com/>Tienda</a></li><li><a href=https://www.youtube.com/channel/UCPE3EUzO58EBHzrJp2Fv7_A>Youtube</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://tienda.sysarmy.com/>Tienda</a></li><li><a href=https://www.youtube.com/channel/UCPE3EUzO58EBHzrJp2Fv7_A>Youtube</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar</h1><div class=post-meta><span class=post-date>December 19, 2020
</span><span class=post-read-time>— 5 minutos de lectura aprox.</span></div><span class=post-tags><a href=https://sysarmy.com/blog/tags/sysadmin/>#sysadmin</a>&nbsp;
<a href=https://sysarmy.com/blog/tags/ssh/>#ssh</a>&nbsp;
<a href=https://sysarmy.com/blog/tags/proxy/>#proxy</a>&nbsp;
<a href=https://sysarmy.com/blog/tags/jumphost/>#jumphost</a>&nbsp;
<a href=https://sysarmy.com/blog/tags/bastion/>#bastion</a>&nbsp;</span><figure class=post-cover><img src=https://sysarmy.com/blog/assets/proxyjump_5_akrI3NN_Ai7lO1ci.jpg alt="Proxyjump, la opción de SSH de la que probablemente nunca hayas escuchado hablar"></figure><div class=post-content><base href=https://sysarmy.com/blog/><p>Hoy en día, es cada vez más común que los Penetration Testers, los investigadores de seguridad, Red Teams y <strong>casi cualquier persona que trabaje en sistemas</strong> requieran algún tipo de tunneling dentro y fuera de la infraestructura de una organización. Los red teams internos, especialmente, que pueden necesitar delimitar su infraestructura de comando y control, probablemente emplearán túneles <a href=https://www.ssh.com/ssh/tunneling/>SSH</a> (o VPN, pero esa será en otra publicación) de su infraestructura externa (como callback servers, alojamiento web, correo, etc. ) hacia los activos Internos.</p><p>La configuración de estos túneles puede volverse bastante compleja y difícil de administrar, especialmente una vez que aumenta el número de saltos entre servidores.</p><h1 id=tunneling>Tunneling</h1><p><img src=assets/proxyjump_0_6CDo8qwaLsxZcFB8.jpg alt></p><p>Los túneles SSH en cascada pueden ser un verdadero dolor de cabeza.
Para el propósito de esta publicación de blog, se ha configurado un entorno como se muestra a continuación. El objetivo es garantizar que los beacons de las víctimas puedan llegar al teamserver host que se encuentra en las profundidades del datacenter corporativo.</p><p><img src=assets/proxyjump_1_QtXI5oI-D15ceS3z.png alt></p><p>Históricamente, debido a mi propia ignorancia de las opciones avanzadas de SSH, intentaría administrar estos múltiples túneles conectando en cascada cada túnel a otro:</p><p><img src=assets/proxyjump_2_zlM5vN8xcIZKD3Nt.png alt></p><p>Para asegurar que las balizas lleguen al último salto podría llegar al teamserver interno, los comandos de túnel múltiples se ven así:</p><pre><code>[teamserver]
ssh -R 8080:127.0.0.1:80 internal-proxy -f -N

[Int. Proxy Server]
ssh -R 8080:127.0.0.1:8080 external-proxy -f -N

[Ext. Proxy Server ]
ssh -R 0.0.0.0:8080:127.0.0.1:8080 last-hop -f -N
</code></pre><p>Después de ejecutar cada uno de los respectivos comandos, una simple solicitud web demuestra que la solicitud web sigue a cada uno de los túneles hasta el teamserver.</p><p><img src=assets/proxyjump_3_qdDqfCNlcQPwJpIN.png alt>
<img src=assets/proxyjump_4_OaO9na6FNeG0C1Qz.png alt></p><p>Configurar esto requiere que cada uno de estos comandos se ejecute en las respectivas máquinas. Sin embargo, cualquier cambio requiere matar el túnel en cada punto y volver a ejecutarlo. El dolor de cabeza en la práctica, sin algún tipo de software de administración que se ejecute en cada uno de los servidores, se vuelve muy evidente. Debe existir una forma más sencilla de gestionar estos túneles.</p><h1 id=proxyjump>ProxyJump</h1><p><img src=assets/proxyjump_5_akrI3NN_Ai7lO1ci.jpg alt></p><p>Al igual que descubrimos el mes pasado sobre Aliens, ¡<a href=https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts>ProxyJump</a> es algo real!
Entra <a href=https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts>ProxyJump</a>, una opción avanzada de SSH que es simplemente una simplificación de ProxyCommand (<code>ProxyCommand ssh proxy-host -W% h:% p</code>). ProxyJump permite que un túnel SSH pivote a través de un host SSH (proxy) a otro. La opción ProxyJump puede ser invocada por <code>-J</code> en la línea de comando:</p><pre><code>ssh -J internal-proxy last-hop -f -N
</code></pre><p>Mi preferencia personal es usar una configuración SSH (<em>/home/user/.ssh/config</em>) y llaves SSH (si no, se le pedirá una contraseña para iniciar sesión en cada salto de ProxyJump). Aquí, se puede especificar un solo salto como tal para SSH:</p><pre><code>Host internal-proxy
   HostName 10.20.30.253
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
Host last-hop
   HostName 10.100.2.240
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump internal-proxy
</code></pre><p>Guardando el ejemplo anterior y ejecutando el comando <code>ssh last-hop</code>, el prompt de last-hop se presenta a continuación (con output de <code>netstat</code>). Se ve internal-proxy conectado a través del puerto TCP 22 y viceversa.</p><p><img src=assets/proxyjump_6_bMFeEgZWWmpBFNwR.png alt></p><p>Ok, ¿qué pasa con los proxies múltiples? Como se hace referencia <a href=https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts>aquí</a>, uno debe simplemente encadenar los proxies en el orden del más cercano al más lejano del servidor del equipo en la configuración SSH:</p><pre><code>Host internal-proxy
   HostName 10.20.30.253
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
Host external-proxy
   HostName 10.100.2.200
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump internal-proxy
Host next-hop
   HostName 10.100.2.210
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump external-proxy
Host last-hop
   HostName 10.100.2.240
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump next-hop
</code></pre><p>Ejecutando <code>ssh last-hop</code> y luego ejecutando <code>netstat</code> desde last-hop, se muestra que <code>next-hop</code> es el único sistema conectado a través del puerto TCP 22 a <code>last-hop</code>:</p><p><img src=assets/proxyjump_7_zEVxPtJ0syTNhLta.png alt></p><p>Entonces, ¿cómo ayuda esto a hacer un túnel hacia adelante? Bueno, simplemente agregando la línea <code>RemoteForward 8080 127.0.0.1:80</code> al final de la configuración SSH configurará el puerto remoto hacia adelante:</p><pre><code>Host last-hop
   HostName 10.100.2.240
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump next-hop
   RemoteForward 8080 127.0.0.1:80
</code></pre><p>Después de guardar la configuración y ejecutar esta vez (<em>ssh last-hop</em>), un <code>netstat</code> rápido en last-hop muestra que 8080 ahora está vinculado. Además, el uso de curl para solicitar last-hop:8080 muestra que el túnel efectivamente reenvía cualquier solicitud de last-hop a través de next-hop, external-proxy e internal-proxy al teamserver en el puerto 80:</p><p><img src=assets/proxyjump_8_JpdH0YiLpskQvFcN.png alt></p><p>Si diferentes hosts de salto usan archivos de identidad distintos, el usuario y el archivo de identidad solo necesitan coincidir con su respectivo host en la configuración. Por ejemplo, en nuestra configuración de demostración, usaremos user2 como una identidad en el proxy interno y nopriv en el last-hop:</p><pre><code>Host internal-proxy
   HostName 10.20.30.253
   Port 22
   User user2
   IdentityFile /home/nopriv/.ssh/user2
[…]
Host last-hop
   HostName 10.100.2.240
   Port 22
   User nopriv
   IdentityFile /home/nopriv/.ssh/id_rsa
   ProxyJump internal-proxy
</code></pre><p>Ejecutando nuestro comando ssh last-hop ,presenta un inicio de sesión con éxito en el last-hop a través de internal-proxy, external-proxy y next-hop:</p><p><img src=assets/proxyjump_9_7-wR2SDk30xpHR_-.png alt></p><p>El intercambio de llaves con internal-proxy verifica que las credenciales de user2 se usaron en la autenticación:</p><p><img src=assets/proxyjump_10_Q8gsu5j5Whabx-V_.png alt></p><h1 id=conclusión>Conclusión</h1><p>En resumen, ProxyJump es una manera fácil de administrar túneles SSH a través de proxies, extendiendo servicios que pueden estar en las profundidades del datacenter corporativo o en la nube a donde se los necesite. El uso de ProxyJump minimiza la cantidad de túneles separados requeridos y cuando se combinan configuraciones SSH, la modificación de dichos túneles es bastante simple y rápida.</p><ul><li><a href=https://medium.com/maverislabs/proxyjump-the-ssh-option-you-probably-never-heard-of-2d7e41d43464>Artículo Original</a></li><li>Traducción y ajuste <a href=https://github.com/GeekBeardLinks>modri</a> <a href=https://github.com/sysarmy/disneyland/issues/43>#43</a></li></ul><div class=ve-desktop><ins class=dcmads style=display:inline-block;width:728px;height:90px data-dcm-placement=N410401.3634809SYSARMY.COMBLOG/B10464038.251052924 data-dcm-rendering-mode=iframe data-dcm-https-only data-dcm-resettable-device-id data-dcm-app-id><script src=https://www.googletagservices.com/dcm/dcmads.js></script></ins></div><div class=ve-mobile><ins class=dcmads style=display:inline-block;width:320px;height:50px data-dcm-placement=N410401.3634809SYSARMY.COMBLOG/B10464038.250920272 data-dcm-rendering-mode=iframe data-dcm-https-only data-dcm-resettable-device-id data-dcm-app-id><script src=https://www.googletagservices.com/dcm/dcmads.js></script></ins></div><script>if(window.innerWidth<960)for(var divsToHide=document.getElementsByClassName("ve-desktop"),i=0;i<divsToHide.length;i++)divsToHide[i].style.visibility="hidden",divsToHide[i].style.display="none";else for(divsToHide=document.getElementsByClassName("ve-mobile"),i=0;i<divsToHide.length;i++)divsToHide[i].style.visibility="hidden",divsToHide[i].style.display="none"</script></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Leer otros posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://sysarmy.com/blog/posts/resultados-de-la-encuesta-de-sueldos-2021-1/><span class=button__icon>←</span>
<span class=button__text>Resultados de la Encuesta de sueldos 2021.1</span>
</a></span><span class="button next"><a href=https://sysarmy.com/blog/posts/10-proyectos-para-automation-engineers/><span class=button__text>10 proyectos de portfolio para aspirantes a automation engineer</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/blog class=logo style=text-decoration:none><span class=logo__mark><svg class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>sysarmy:~ blog$</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2025 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://sysarmy.com/blog/assets/main.js></script><script src=https://sysarmy.com/blog/assets/prism.js></script></div></body></html>